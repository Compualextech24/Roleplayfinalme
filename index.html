<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Configura tu IA</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #config-container, #chat-container { width: 450px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #chat-container { display: none; flex-direction: column; height: 600px; padding: 0; }
        
        /* Estilos del Formulario */
        .field { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        /* Botones */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #btn-start { background: #25d366; color: white; }
        #btn-test { background: #e4e6eb; color: #444; }
        
        /* Chat */
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        #input-area { display: flex; padding: 15px; background: #f0f0f0; }
        .user-msg { align-self: flex-end; background: #0084ff; color: white; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; }
        .ia-msg { align-self: flex-start; background: #e4e6eb; color: black; padding: 10px 15px; border-radius: 15px 15px 15px 0; max-width: 80%; }
        
        /* Cr√©ditos */
        #credits-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        #credits-amount { font-size: 24px; margin-top: 5px; }
    </style>
</head>
<body>

<!-- ============================================ -->
<!-- CONTENEDOR DE CONFIGURACI√ìN INICIAL -->
<!-- Permite al usuario personalizar nombre, personalidad, voz y modelo de IA -->
<!-- ============================================ -->
<div id="config-container">
    <h2 style="text-align: center;">Configura a tu Amigo/a</h2>
    
    <!-- ============================================ -->
    <!-- INFORMACI√ìN DE CR√âDITOS PUTER -->
    <!-- Muestra el uso mensual de cr√©ditos disponibles -->
    <!-- ============================================ -->
    <div id="credits-info">
        <div>üí∞ Cr√©ditos Puter Disponibles</div>
        <div id="credits-amount">Cargando...</div>
    </div>
    
    <div class="field">
        <label>Modelo de IA:</label>
        <select id="ai-model">
            <option value="gemini">Google Gemini 2.5 Flash</option>
            <option value="openai">OpenAI GPT-4o-mini</option>
        </select>
    </div>
    
    <div class="field">
        <label>Nombre:</label>
        <input type="text" id="ai-name" placeholder="Ej: Kasandra">
    </div>
    
    <div class="field">
        <label>Personalidad:</label>
        <textarea id="ai-persona" rows="2" placeholder="Ej: Novia cari√±osa, joven y p√≠cara"></textarea>
    </div>
    
    <div class="field">
        <label>Voz (Mejores opciones):</label>
        <select id="voice-select">
            <!-- VOCES NEURALES - MEJOR CALIDAD Y M√ÅS NATURALES -->
            <optgroup label="üá™üá∏ Espa√±a (Neural - Mejor calidad)">
                <option value="Lucia-neural">Luc√≠a (Mujer, Neural)</option>
                <option value="Sergio-neural">Sergio (Hombre, Neural)</option>
            </optgroup>
            
            <optgroup label="üá≤üáΩ M√©xico (Neural)">
                <option value="Mia-neural">Mia (Mujer, Neural)</option>
                <option value="Andres-neural">Andr√©s (Hombre, Neural)</option>
            </optgroup>
            
            <optgroup label="üá∫üá∏ Espa√±ol Latino (Neural)">
                <option value="Lupe-neural">Lupe (Mujer, Neural)</option>
                <option value="Pedro-neural">Pedro (Hombre, Neural)</option>
            </optgroup>
            
            <!-- VOCES EST√ÅNDAR - CALIDAD B√ÅSICA -->
            <optgroup label="Otras voces est√°ndar">
                <option value="Conchita">Conchita (Espa√±a, Est√°ndar)</option>
                <option value="Enrique">Enrique (Espa√±a, Est√°ndar)</option>
            </optgroup>
        </select>
    </div>
    
    <button id="btn-test" class="btn">Escuchar Prueba</button>
    <button id="btn-start" class="btn">Empezar Chat</button>
</div>

<!-- ============================================ -->
<!-- CONTENEDOR DEL CHAT -->
<!-- Se muestra despu√©s de configurar la IA -->
<!-- ============================================ -->
<div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Escribe un mensaje...">
        <button id="btn-enviar" style="margin-left:10px; background:#0084ff; color:white; border:none; border-radius:20px; padding:10px 20px; cursor:pointer;">Enviar</button>
    </div>
</div>

<script>
    // ============================================
    // CONFIGURACI√ìN GLOBAL
    // API Keys y variables de configuraci√≥n
    // ============================================
    const GEMINI_API_KEY = "AIzaSyB0_IdzegxYXy-9HVoi0nG84dSMjBuiUWo";
    const OPENAI_API_KEY = "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";
    let nombreIA = "", personalidadIA = "", vozSeleccionada = "", modeloSeleccionado = "";
    let conversacionIniciada = false;

    // ============================================
    // CARGAR CR√âDITOS DE PUTER AL INICIAR
    // Obtiene el uso mensual de cr√©ditos disponibles
    // ============================================
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const usage = await puter.auth.getMonthlyUsage();
            const creditsElement = document.getElementById('credits-amount');
            
            if (usage && usage.monthly_limit) {
                const usados = usage.monthly_usage || 0;
                const limite = usage.monthly_limit;
                const disponibles = limite - usados;
                creditsElement.textContent = `${disponibles.toLocaleString()} / ${limite.toLocaleString()}`;
            } else {
                creditsElement.textContent = "‚àû (Ilimitado)";
            }
        } catch (error) {
            document.getElementById('credits-amount').textContent = "No disponible";
            console.error("Error al obtener cr√©ditos:", error);
        }
    });

    // ============================================
    // FUNCI√ìN: PROBAR VOZ
    // Reproduce una muestra de audio con la voz seleccionada
    // ============================================
    document.getElementById('btn-test').onclick = () => {
        const vozInput = document.getElementById('voice-select').value;
        
        // Separar nombre de voz y tipo de engine (neural o standard)
        const [voz, engine] = vozInput.includes('-neural') 
            ? [vozInput.replace('-neural', ''), 'neural'] 
            : [vozInput, 'standard'];
        
        // Determinar el idioma seg√∫n la voz seleccionada
        let lang = 'es-US'; // Por defecto
        if (voz === 'Lucia' || voz === 'Sergio' || voz === 'Conchita' || voz === 'Enrique') {
            lang = 'es-ES'; // Espa√±a
        } else if (voz === 'Mia' || voz === 'Andres') {
            lang = 'es-MX'; // M√©xico
        }
        
        // Reproducir audio de prueba con Puter.js
        puter.ai.txt2speech("¬°Hola! Soy tu nueva amiga. ¬øTe gusta c√≥mo suena mi voz?", {
            voice: voz,
            engine: engine,
            language: lang
        }).then(a => a.play());
    };

    // ============================================
    // FUNCI√ìN: INICIAR CHAT
    // Guarda la configuraci√≥n y muestra la interfaz del chat con mensaje inicial
    // ============================================
    document.getElementById('btn-start').onclick = () => {
        nombreIA = document.getElementById('ai-name').value || "Amigo";
        personalidadIA = document.getElementById('ai-persona').value || "Un amigo amable";
        vozSeleccionada = document.getElementById('voice-select').value;
        modeloSeleccionado = document.getElementById('ai-model').value;
        
        // Ocultar configuraci√≥n y mostrar chat
        document.getElementById('config-container').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';
        
        // ============================================
        // MOSTRAR MENSAJE INICIAL DEL SISTEMA
        // Indica al usuario con qu√© modelo va a hablar
        // ============================================
        const modeloNombre = modeloSeleccionado === 'gemini' ? 'Google Gemini 2.5 Flash' : 'OpenAI GPT-4o-mini';
        const mensajeInicial = document.createElement('div');
        mensajeInicial.className = 'ia-msg';
        mensajeInicial.style.background = '#fff3cd';
        mensajeInicial.style.color = '#856404';
        mensajeInicial.innerText = `Hola, est√°s a punto de hablar con un modelo de ${modeloNombre}. Di "hola" para iniciar una conversaci√≥n.`;
        contenedor.appendChild(mensajeInicial);
    };

    // ============================================
    // REFERENCIAS A ELEMENTOS DEL CHAT
    // ============================================
    const contenedor = document.getElementById('messages');
    const entrada = document.getElementById('user-input');

    // ============================================
    // FUNCI√ìN: ENVIAR MENSAJE
    // Env√≠a mensaje del usuario a la IA seleccionada y reproduce respuesta con voz
    // ============================================
    async function enviar() {
        const texto = entrada.value.trim();
        if (!texto) return;

        // MOSTRAR MENSAJE DEL USUARIO
        const dUser = document.createElement('div');
        dUser.className = 'user-msg';
        dUser.innerText = texto;
        contenedor.appendChild(dUser);
        entrada.value = "";

        // CREAR ELEMENTO PARA LA RESPUESTA DE LA IA
        const dIA = document.createElement('div');
        dIA.className = 'ia-msg';
        dIA.innerText = "...";
        contenedor.appendChild(dIA);
        contenedor.scrollTop = contenedor.scrollHeight;

        // ============================================
        // ACTIVAR PERSONALIDAD DESPU√âS DEL PRIMER MENSAJE
        // La IA adopta nombre y personalidad despu√©s del "hola" inicial
        // ============================================
        if (!conversacionIniciada) {
            conversacionIniciada = true;
        }

        try {
            if (modeloSeleccionado === 'gemini') {
                // ============================================
                // LLAMADA A LA API DE GEMINI 2.5 FLASH
                // Genera respuesta en streaming desde Google AI
                // ============================================
                const prompt = conversacionIniciada 
                    ? `Tu nombre es ${nombreIA}. Tu personalidad es: ${personalidadIA}. Responde de manera natural y coherente a: ${texto}`
                    : texto;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:streamGenerateContent?alt=sse&key=${GEMINI_API_KEY}`;
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                // ============================================
                // PROCESAR RESPUESTA EN STREAMING (GEMINI)
                // Lee y muestra el texto generado en tiempo real
                // ============================================
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let finalMsg = "";
                dIA.innerText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const l of lines) {
                        if (l.startsWith('data: ')) {
                            const json = JSON.parse(l.substring(6));
                            if (json.candidates) {
                                const part = json.candidates[0].content.parts[0].text;
                                finalMsg += part;
                                dIA.innerText = finalMsg;
                                contenedor.scrollTop = contenedor.scrollHeight;
                            }
                        }
                    }
                }

                // ============================================
                // REPRODUCIR RESPUESTA CON VOZ (GEMINI)
                // ============================================
                reproducirVoz(finalMsg);

            } else if (modeloSeleccionado === 'openai') {
                // ============================================
                // LLAMADA A LA API DE OPENAI GPT-4O-MINI
                // Genera respuesta usando OpenAI (CORREGIDO)
                // ============================================
                const prompt = conversacionIniciada 
                    ? `Tu nombre es ${nombreIA}. Tu personalidad es: ${personalidadIA}. Responde de manera natural y coherente a: ${texto}`
                    : texto;

                const res = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini', // Modelo correcto y m√°s econ√≥mico
                        messages: [
                            { role: 'system', content: `Eres ${nombreIA}. ${personalidadIA}` },
                            { role: 'user', content: texto }
                        ],
                        stream: false, // Sin streaming para evitar errores
                        max_tokens: 500,
                        temperature: 0.8
                    })
                });

                // ============================================
                // PROCESAR RESPUESTA (OPENAI - SIN STREAMING)
                // Lee y muestra el texto generado
                // ============================================
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`OpenAI API Error: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await res.json();
                const finalMsg = data.choices[0].message.content;
                dIA.innerText = finalMsg;
                contenedor.scrollTop = contenedor.scrollHeight;

                // ============================================
                // REPRODUCIR RESPUESTA CON VOZ (OPENAI)
                // ============================================
                reproducirVoz(finalMsg);
            }
            
        } catch (e) { 
            dIA.innerText = "‚ùå Error: " + e.message;
            console.error('Error completo:', e);
        }
    }

    // ============================================
    // FUNCI√ìN: REPRODUCIR VOZ
    // Convierte texto a audio usando Puter.js con la voz configurada
    // ============================================
    function reproducirVoz(texto) {
        const vozInput = vozSeleccionada;
        const [voz, engine] = vozInput.includes('-neural') 
            ? [vozInput.replace('-neural', ''), 'neural'] 
            : [vozInput, 'standard'];
        
        // Determinar el idioma seg√∫n la voz seleccionada
        let lang = 'es-US';
        if (voz === 'Lucia' || voz === 'Sergio' || voz === 'Conchita' || voz === 'Enrique') {
            lang = 'es-ES';
        } else if (voz === 'Mia' || voz === 'Andres') {
            lang = 'es-MX';
        }
        
        puter.ai.txt2speech(texto, {
            voice: voz,
            engine: engine,
            language: lang
        }).then(a => a.play()).catch(err => {
            console.error('Error reproduciendo voz:', err);
        });
    }

    // ============================================
    // EVENTOS DE ENV√çO
    // Permite enviar mensajes con bot√≥n o tecla Enter
    // ============================================
    document.getElementById('btn-enviar').onclick = enviar;
    entrada.onkeypress = (e) => { 
        if(e.key === 'Enter') enviar(); 
    };
</script>

</body>
</html>

